name: Update GitHub Stats

on:
  schedule:
    - cron: "0 */6 * * *"   # every 6 hours
  workflow_dispatch:

jobs:
  stats:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install requests pytz

      - name: Generate stats
        env:
          GH_TOKEN: ${{ secrets.GH_STATS_TOKEN }}
        run: |
          python << 'EOF'
          import requests, os, pytz
          from datetime import datetime

          headers = {"Authorization": f"token {os.environ['GH_TOKEN']}"}
          user = "Rumesha400"

          user_data = requests.get(f"https://api.github.com/users/{user}", headers=headers).json()
          repos = requests.get(f"https://api.github.com/user/repos?per_page=100", headers=headers).json()

          public_repos = user_data.get("public_repos", 0)
          private_repos = sum(1 for r in repos if r.get("private"))

          commits = 0
          pulls = 0

          for repo in repos:
              owner = repo["owner"]["login"]
              name = repo["name"]

              commits += len(requests.get(
                  f"https://api.github.com/repos/{owner}/{name}/commits?author={user}",
                  headers=headers
              ).json())

              pulls += len(requests.get(
                  f"https://api.github.com/repos/{owner}/{name}/pulls?state=all",
                  headers=headers
              ).json())

          ist = pytz.timezone("Asia/Kolkata")
          now = datetime.now(ist).strftime("%Y-%m-%d %H:%M IST")

          block = f"""
### ðŸ“Š Complete GitHub Statistics (Including Private Repos)
- **Total Pull Requests**: **{pulls}**
- **Public Repositories**: **{public_repos}**
- **Private Repositories**: **{private_repos}**
- **Total Commits**: **{commits}**
- **Last Updated**: **{now}**
"""

          with open("README.md", "r") as f:
              content = f.read()

          start = "<!--START_GH_STATS-->"
          end = "<!--END_GH_STATS-->"
          new = start + block + end

          content = content.split(start)[0] + new + content.split(end)[1]

          with open("README.md", "w") as f:
              f.write(content)
          EOF

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md
          git commit -m "Auto-update GitHub stats" || echo "No changes"
          git push
